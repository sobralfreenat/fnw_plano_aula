<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Aula: Meios de Pagamento para E-commerce (com Tutorial)</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            line-height: 1.6; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f4; 
            color: #333;
            /* Default padding for desktop */
            padding-left: 270px; 
            transition: padding-left 0.3s ease-in-out;
        }

        #fixed-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px; 
            height: 100vh;
            background-color: #e9ecef;
            padding: 20px 15px;
            z-index: 1001;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            border-right: 1px solid #ccc;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        /* Class to show sidebar on mobile */
        #fixed-sidebar.sidebar-open {
            transform: translateX(0);
        }

        .sidebar-logo {
            font-weight: bold;
            font-size: 1.6em;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }
        .sidebar-item {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .sidebar-item h4 {
            font-size: 1.1em;
            color: #3498db;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .sidebar-item .name-input,
        .sidebar-item .url-input {
            width: calc(100% - 16px); /* padding considered */
            padding: 6px 8px;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .sidebar-item .add-button,
        .sidebar-item .demo-button {
            padding: 7px 10px;
            font-size: 0.85em;
            width: 100%;
            box-sizing: border-box;
        }
         .sidebar-item .demo-button {
            margin-top: 8px; /* Space between save collection and open button */
        }
        .sidebar-item .collection-management {
            margin-top: 8px;
            padding-top: 8px;
            border-top: none; /* Removing double border */
            flex-direction: column; /* Stack label/select and button */
        }
        .sidebar-item .collection-management label {
            margin-bottom: 5px; /* Space between label and select */
            font-size: 0.85em;
        }
        .sidebar-item .url-select {
            width: 100%;
            margin-bottom: 8px; /* Space between select and save button */
            font-size: 0.85em;
            padding: 6px 8px;
        }
        .sidebar-item .add-button {
            margin-top: 0; /* Add button comes after select */
        }

        #sidebar-toggle-button {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1002; /* Above sidebar */
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            display: none; /* Hidden by default, shown in media query */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Media Query for mobile devices */
        @media (max-width: 768px) {
            body {
                padding-left: 0; /* No padding when sidebar is hidden */
            }
            #fixed-sidebar {
                transform: translateX(-100%); /* Hide sidebar off-screen */
                /* box-shadow: none; /* Optional: remove shadow when hidden to prevent edge peeking */
            }
            #fixed-sidebar.sidebar-open {
                transform: translateX(0); /* Bring sidebar on-screen */
                box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Show shadow when open */
            }
            #sidebar-toggle-button {
                display: block; /* Show hamburger button */
            }
            .container {
                margin: 20px 15px; /* Adjust margin for smaller screens */
                padding: 15px;
            }
        }

        /* Ensure main container respects the sidebar */
        .container { 
            max-width: 850px; 
            margin: 20px auto; 
            background: #fff; 
            padding: 20px 30px; 
            border-radius: 8px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1); 
        }
        h1 { color: #2c3e50; text-align: center; font-size: 1.8em; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
        .page-subtitle { 
            text-align: center; 
            font-size: 1.1em; 
            color: #555; 
            margin-top: -5px; /* Pull up closer to H1 */
            margin-bottom: 25px; 
            font-style: italic;
        }
        h2 { color: #3498db; font-size: 1.5em; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #eaeaea; padding-bottom: 8px; }
        h3 { color: #2980b9; font-size: 1.25em; margin-top: 25px; margin-bottom: 10px; }
        p { margin-bottom: 12px; }
        ul, ol { padding-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 8px; }
        strong { font-weight: 600; color: #2c3e50; }
        em { font-style: italic; color: #555; }
        code { background-color: #ecf0f1; padding: 3px 6px; border-radius: 4px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; color: #c0392b; }
        .lesson-section { margin-bottom: 25px; }
        .resource-placeholder {
            background-color: #eaf5ff;
            border: 1px dashed #aed6f1;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-style: italic;
            color: #2874a6;
        }
        .resource-placeholder strong { color: #1f618d; }
        .note { font-size: 0.9em; color: #7f8c8d; margin-top: 5px;}

        /* Estilos para o botão de demonstração */
        .demo-button {
            background-color: #3498db; /* Cor do botão */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.3s ease;
            display: inline-block;
            margin-top: 5px;
        }
        .demo-button:hover {
            background-color: #2980b9;
        }

        /* Estilos para o Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 400px; /* Largura definida */
            max-width: 90%;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-content iframe {
            width: 100%;
            height: 450px; /* Altura exemplo, pode ser ajustada */
            border: none;
            display: block; /* Para remover espaço extra abaixo do iframe */
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            line-height: 1;
            cursor: pointer;
            color: #777;
        }
        .modal-close-button:hover {
            color: #333;
        }
        /* Estilo para o campo de input de URL */
        .url-input {
            width: calc(100% - 22px); /* Leva em conta padding e borda */
            padding: 8px 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .name-input {
            width: calc(100% - 22px);
            padding: 8px 10px;
            margin-bottom: 5px; 
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .action-button-group {
            margin-bottom: 15px; /* Espaço antes dos controles da coleção */
        }
        .collection-management {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            display: flex; /* Para alinhar label, select e botão */
            align-items: center; /* Alinha verticalmente os itens */
            flex-wrap: wrap; /* Permite quebra de linha se não couber */
        }
        .collection-management label {
            margin-right: 8px;
            font-size: 0.9em;
            color: #555;
        }
        .add-button, .url-select {
            padding: 8px 10px;
            font-size: 0.9em;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 5px;
        }
        .add-button {
            background-color: #28a745; /* Verde para adicionar */
            color: white;
            cursor: pointer;
        }
        .add-button:hover {
            background-color: #218838;
        }
        .url-select {
            min-width: 200px; /* Para dar um tamanho inicial ao select */
            background-color: white;
        }

        /* Sidebar Accordion styles */
        .accordion-header {
            background-color: #d1dce5;
            color: #2c3e50;
            cursor: pointer;
            padding: 10px 12px;
            width: 100%;
            text-align: left;
            border: none;
            border-radius: 4px;
            outline: none;
            transition: background-color 0.3s ease;
            font-size: 1.05em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 0; /* Remove bottom margin if panel follows directly */
        }
        .accordion-header:hover {
            background-color: #c1cdd9;
        }
        .accordion-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .accordion-panel {
            padding: 0 10px; /* Padding for content inside panel */
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            border: 1px solid #d1dce5; /* Border to match header */
            border-top: none;
            margin-bottom: 15px; /* Space after the panel */
        }
        .accordion-panel.show {
             padding-top: 10px; /* Add padding when shown */
             padding-bottom: 10px;
        }
        .accordion-panel textarea {
            width: calc(100% - 16px);
            min-height: 150px;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9em;
            resize: vertical;
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            pointer-events: none;
        }
        
        .tutorial-container {
            position: fixed;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            max-width: 400px;
            z-index: 9999;
            pointer-events: auto;
        }
        
        .tutorial-titulo {
            font-size: 1.2em;
            color: #3498db;
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-right: 25px; /* Espaço para o botão fechar */
        }
        
        .tutorial-descricao {
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        .tutorial-botoes {
            display: flex;
            justify-content: space-between;
        }
        
        .tutorial-botao {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .tutorial-botao-anterior {
            background-color: #e0e0e0;
            color: #555;
        }
        
        .tutorial-botao-proximo {
            background-color: #3498db;
            color: white;
        }
        
        .tutorial-botao-fechar {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Botão X para fechar a qualquer momento */
        .tutorial-fechar-x {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            line-height: 1;
            color: #999;
            cursor: pointer;
            padding: 0;
        }
        
        .tutorial-fechar-x:hover {
            color: #e74c3c;
        }
        
        /* Timeline de passos do tutorial */
        .tutorial-timeline {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .tutorial-ponto {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tutorial-ponto:hover {
            background-color: #95a5a6;
            transform: scale(1.2);
        }
        
        .tutorial-ponto.ativo {
            background-color: #3498db;
            transform: scale(1.3);
        }

        .tutorial-elemento-destacado {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.8);
            border-radius: 3px;
        }
        a
        .tutorial-botao-sidebar {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button id="sidebar-toggle-button">&#9776;</button> <!-- Hamburger Icon -->

    <div id="fixed-sidebar">
        <div class="sidebar-logo">SISTEMA COM TUTORIAL</div>
        
        <!-- Novo seletor de planos de aula -->
        <div class="sidebar-item">
            <h4>Planos de Aula</h4>
            <p style="font-size: 0.85em; margin-bottom: 10px;">
                Gerenciar planos:
            </p>
            <select id="planoPreConfigurado" class="url-select" style="width: 100%; margin-bottom: 8px;">
                <option value="">Escolha um plano...</option>
                <option value="meios_pagamento">Meios de Pagamento para E-commerce</option>
            </select>
            <div style="display: flex; margin-bottom: 8px;">
                <button class="demo-button" style="flex: 1; margin-right: 4px;" onclick="carregarPlanoPreConfigurado()">
                    Carregar Plano
                </button>
                <button class="demo-button" style="flex: 1; background-color: #e74c3c;" onclick="removerPlanoSelecionado()">
                    Remover
                </button>
            </div>
            <div style="display: flex; margin-bottom: 8px;">
                <button class="demo-button" style="flex: 1; margin-right: 4px; background-color: #7f8c8d;" onclick="moverPlanoParaCima()">
                    ▲ Mover Acima
                </button>
                <button class="demo-button" style="flex: 1; background-color: #7f8c8d;" onclick="moverPlanoParaBaixo()">
                    ▼ Mover Abaixo
                </button>
            </div>
            <hr style="margin: 15px 0; border-top: 1px dashed #ccc;">
            <button class="demo-button" style="width: 100%; background-color: #28a745; margin-bottom: 8px;" onclick="salvarComoNovoPlano()">
                Salvar Atual como Novo Plano
            </button>
            <p style="font-size: 0.85em; margin-bottom: 10px;">
                Importar/Exportar planos:
            </p>
            <button class="demo-button" style="width: 100%; background-color: #3498db; margin-bottom: 8px;" onclick="exportarPlanoLocal()">
                Exportar Plano Atual
            </button>
            <input type="file" id="carregarPlanoInput" accept=".json" style="display: none;">
            <button class="demo-button" style="width: 100%; background-color: #17a2b8;" onclick="document.getElementById('carregarPlanoInput').click()">
                Importar Plano de Arquivo
            </button>
        </div>
        
        <!-- Accordion for New Module Content -->
        <button class="accordion-header">Novo Conteúdo da Aula</button>
        <div class="accordion-panel">
            <p style="font-size:0.85em; color:#555; margin-bottom:8px;">Cole o texto do novo módulo/aula abaixo. A estrutura será identificada para gerar o conteúdo na página.</p>
            <textarea id="newModuleTextarea" placeholder="Cole aqui o conteúdo do novo módulo/aula..."></textarea>
            <button class="demo-button" style="width:100%; box-sizing:border-box;" onclick="generateModuleContent()">Gerar Conteúdo da Aula</button>
        </div>

        <div class="sidebar-item">
            <h4>Assistente IA</h4>
            <input type="text" id="nameSidebarIA" class="name-input" placeholder="Nome para o Link IA">
            <input type="text" id="urlSidebarIA" class="url-input" value="https://chat.openai.com/" placeholder="URL do Assistente IA">
            
            <label for="selectSidebarIA" style="font-size: 0.85em; display: block; margin-bottom: 5px; margin-top: 8px;">Carregar da Coleção:</label>
            <select id="selectSidebarIA" class="url-select" onchange="loadUrlFromSelect('selectSidebarIA', 'urlSidebarIA', 'nameSidebarIA')">
                <option value="">Links Salvos IA...</option>
            </select>

            <button class="add-button" style="margin-top: 8px; width: 100%; box-sizing: border-box;" onclick="addToCollection('nameSidebarIA', 'urlSidebarIA', 'selectSidebarIA', 'sidebar_ia')">Salvar Link Atual</button>
            <button class="demo-button" onclick="handleOpenModal('urlSidebarIA')">Abrir URL do Assistente</button>
        </div>

        <!-- Spacer -->
        <div style="flex-grow: 1;"></div> 

        <!-- Configuration Management Section -->
        <div style="margin-top:30px; padding-top:15px; border-top: 1px solid #ccc;">
            <h4 style="font-size: 1.1em; color: #2c3e50; margin-bottom:10px; text-align:center;">Configurações da Página</h4>
            <button class="demo-button" style="background-color: #28a745; width:100%; box-sizing:border-box; margin-bottom:8px;" onclick="savePageConfigAsJson()">Salvar Configuração em JSON</button>
            <input type="file" id="loadConfigInput" accept=".json" style="display: none;">
            <button class="demo-button" style="background-color: #17a2b8; width:100%; box-sizing:border-box;" onclick="document.getElementById('loadConfigInput').click()">Carregar Configuração de JSON</button>
        </div>

    </div>

    <div class="container">
        <h1>Módulo 1, Aula 1: Meios de Pagamento para E-commerce</h1>
        <p class="page-subtitle">Identificação, Integração e Aplicação em Projetos</p>

        <div id="lesson-sections-wrapper">
            <div class="lesson-section">
                <h2>Objetivos da Aula:</h2>
                <ul>
                    <li>Compreender os diferentes meios de pagamento disponíveis para e-commerce.</li>
                    <li>Analisar as formas de integração desses meios, diferenciando Gateways de Pagamento e Intermediadores (prós e contras).</li>
                    <li>Capacitar os alunos a definir e justificar a escolha dos meios de pagamento e formas de integração para seus projetos de e-commerce.</li>
                    <li>Visualizar como soluções de pagamento podem ser integradas em ambientes online.</li>
                </ul>
            </div>

            <div class="lesson-section">
                <h2>Duração Estimada:</h2>
                <p><strong>Estimativa de Tempo Total para esta Aula:</strong> 1 a 2 horas (flexível conforme a dinâmica do grupo e profundidade das discussões).</p>
            </div>

            <div class="lesson-section">
                <h2>Roteiro da Aula:</h2>
                
                <ol>
                    <li>
                        <h3>Aquecimento e Levantamento de Conhecimento Prévio (15-20 minutos)</h3>
                        <p><strong>Atividade:</strong> Brainstorming.</p>
                        <p><strong>Pergunta Disparadora para os alunos:</strong> "Quais são os meios de pagamento existentes para e-commerce que vocês conhecem ou já utilizaram?"</p>
                        <p><strong>Materiais:</strong> Flipchart ou lousa digital.</p>
                        <p><strong>Condução:</strong> Incentivar a participação e anotar as contribuições (ex: cartão de crédito, boleto, débito, transferência, Pix, carteiras digitais).</p>
                    </li>

                    <li>
                        <h3>Apresentação e Discussão de Vídeo (20-25 minutos)</h3>
                        <p><strong>Atividade:</strong> Apresentar um vídeo sobre o tema e promover uma discussão.</p>
                        
                        <div class="resource-placeholder" style="padding-bottom: 5px; margin-bottom: 5px;">
                            <p><strong>Recurso Sugerido:</strong> Vídeo "Qual a Melhor Forma de Pagamento para sua Loja Virtual?"</p>
                            
                            <input type="text" id="nameVideoRecurso0" class="name-input" value="Qual a Melhor Forma de Pagamento para sua Loja Virtual?" placeholder="Nome/Rótulo para o Vídeo (Ex: Melhor Forma Pagto)" oninput="updateSuggestedVideoUrlFromName()">
                            <input type="text" id="urlVideoRecurso0" class="url-input" value="https://www.youtube.com/results?search_query=Qual+a+Melhor+Forma+de+Pagamento+para+sua+Loja+Virtual" placeholder="URL do Vídeo">
                            
                            <div class="collection-management" style="border-top: none; padding-top: 5px; margin-bottom: 10px; margin-top: 5px;"> 
                                <button class="add-button" onclick="addToCollection('nameVideoRecurso0', 'urlVideoRecurso0', 'selectVideoRecurso0', 'videoRecurso')">Salvar Link Acima na Coleção</button>
                                <label for="selectVideoRecurso0" style="margin-left: 10px;">Carregar da Coleção:</label>
                                <select id="selectVideoRecurso0" class="url-select" onchange="loadUrlFromSelect('selectVideoRecurso0', 'urlVideoRecurso0', 'nameVideoRecurso0')">
                                    <option value="">Selecione um Vídeo Salvo...</option>
                                </select>
                            </div>

                            <div class="action-button-group">
                                <button class="demo-button" onclick="handleOpenModal('urlVideoRecurso0')">Abrir URL do Campo Acima</button>
                            </div>
                        </div>
                        <p style="margin-top: 15px;"><strong>Discussão Pós-Vídeo com os alunos:</strong> "De acordo com o vídeo (e suas experiências), como podemos integrar esses meios de pagamento no e-commerce?"</p>
                    </li>

                    <li>
                        <h3>Exposição Dialogada: Formas de Integração (25-30 minutos)</h3>
                        <p><strong>Tópico Central:</strong> "Formas de Integração dos Meios de Pagamento".</p>
                        <p><strong>Conteúdo a ser abordado:</strong></p>
                        <ul>
                            <li><strong>Gateways de Pagamento:</strong> Definição, funcionamento, vantagens (ex: maior controle, personalização) e desvantagens (ex: custo inicial, complexidade).</li>
                            <li><strong>Intermediadores de Pagamento (Subadquirentes):</strong> Definição, funcionamento, vantagens (ex: facilidade de integração, menor burocracia) e desvantagens (ex: taxas por transação, menor personalização).</li>
                            <li>Mencionar exemplos de mercado para cada um.</li>
                        </ul>
                        <p><strong>Condução:</strong> Expor o conteúdo, incentivar perguntas e comparar as opções.</p>
                    </li>

                    <li>
                        <h3>Atividade Prática para os Alunos (20-30 minutos)</h3>
                        <p><strong>Atividade:</strong> Trabalho com os projetos de e-commerce dos alunos (individual ou em grupo).</p>
                        <p><strong>Tarefa para os alunos:</strong> "Com base no que foi discutido e no perfil do mercado de atuação dos seus projetos, definam:</p>
                        <ol>
                            <li>Quais meios de pagamento pretendem oferecer?</li>
                            <li>Qual forma de integração (Gateway ou Intermediador) seria mais adequada para o estágio inicial do projeto? Justifiquem as escolhas."</li>
                        </ol>
                    </li>
                </ol>
            </div>

            <div class="lesson-section">
                <h2>Recursos Visuais / Demonstrações (Sugestões):</h2>
                <p><em>Para enriquecer a explanação, considere usar os seguintes tipos de demonstrações visuais. Cole aqui as URLs dos recursos escolhidos.</em></p>

                <div class="resource-placeholder">
                    <p><strong>Demonstração Visual 1: Integração de Soluções Externas (Ex: via <code>iframe</code>)</strong></p>
                    <p>Ao explicar Gateways e Intermediadores, pode ser útil mostrar visualmente como uma plataforma online pode "embarcar" soluções externas (como um checkout de pagamento) usando, por exemplo, a técnica de <code>iframe</code>.</p>
                    
                    <input type="text" id="nameRecurso1" class="name-input" placeholder="Termos para busca no Google (Ex: iframe em ação)">
                    <input type="text" id="urlRecurso1" class="url-input" placeholder="URL do Link">
                    
                    <div class="collection-management" style="border-top: none; padding-top: 0; margin-bottom: 10px;"> 
                        <button class="add-button" onclick="addToCollection('nameRecurso1', 'urlRecurso1', 'selectRecurso1', 'recurso1')">Salvar Link Acima na Coleção</button>
                        <label for="selectRecurso1" style="margin-left: 10px;">Carregar da Coleção:</label>
                        <select id="selectRecurso1" class="url-select" onchange="loadUrlFromSelect('selectRecurso1', 'urlRecurso1', 'nameRecurso1')">
                            <option value="">Selecione um Link Salvo...</option>
                        </select>
                    </div>

                    <div class="action-button-group">
                        <button class="demo-button" onclick="handleOpenModal('urlRecurso1')">Abrir URL do Campo Acima</button>
                    </div>
                    <p class="note">Exemplo: Digite termos como "iframe em ação" ou "exemplos de checkout embarcado".</p>
                </div>

                <div class="resource-placeholder">
                    <p><strong>Demonstração Visual 2: Exemplo de Interface de Checkout</strong></p>
                    <p>Para a atividade prática dos alunos, ou para ilustrar os tipos de integração, mostrar um exemplo de como uma interface de checkout (mesmo que simulada ou um mockup) se apresentaria dentro de um ambiente de loja virtual.</p>
                    
                    <input type="text" id="nameRecurso2" class="name-input" placeholder="Nome/Rótulo para o Link (Ex: Checkout Exemplo)">
                    <input type="text" id="urlRecurso2" class="url-input" placeholder="URL do Link">

                    <div class="collection-management" style="border-top: none; padding-top: 0; margin-bottom: 10px;">
                        <button class="add-button" onclick="addToCollection('nameRecurso2', 'urlRecurso2', 'selectRecurso2', 'recurso2')">Salvar Link Acima na Coleção</button>
                        <label for="selectRecurso2" style="margin-left: 10px;">Carregar da Coleção:</label>
                        <select id="selectRecurso2" class="url-select" onchange="loadUrlFromSelect('selectRecurso2', 'urlRecurso2', 'nameRecurso2')">
                            <option value="">Selecione um Link Salvo...</option>
                        </select>
                    </div>

                    <div class="action-button-group">
                        <button class="demo-button" onclick="handleOpenModal('urlRecurso2')">Abrir URL do Campo Acima</button>
                    </div>
                    <p class="note">Exemplo: Um link para um mockup interativo, uma imagem de um bom exemplo de checkout, ou um vídeo de navegação.</p>
                </div>
                
                <div class="resource-placeholder">
                    <p><strong>Demonstração Visual 3 (Opcional): Conceito de SAAS em Plataformas de E-commerce</strong></p>
                    <p>Se relevante, pode-se contextualizar brevemente como plataformas SAAS (Software as a Service) oferecem estruturas prontas que facilitam integrações e o desenvolvimento de lojas virtuais.</p>
                    
                    <input type="text" id="nameRecurso3" class="name-input" placeholder="Nome/Rótulo para o Link (Ex: Artigo SAAS)">
                    <input type="text" id="urlRecurso3" class="url-input" placeholder="URL do Link">

                    <div class="collection-management" style="border-top: none; padding-top: 0; margin-bottom: 10px;">
                        <button class="add-button" onclick="addToCollection('nameRecurso3', 'urlRecurso3', 'selectRecurso3', 'recurso3')">Salvar Link Acima na Coleção</button>
                        <label for="selectRecurso3" style="margin-left: 10px;">Carregar da Coleção:</label>
                        <select id="selectRecurso3" class="url-select" onchange="loadUrlFromSelect('selectRecurso3', 'urlRecurso3', 'nameRecurso3')">
                            <option value="">Selecione um Link Salvo...</option>
                        </select>
                    </div>
                    
                    <div class="action-button-group">
                        <button class="demo-button" onclick="handleOpenModal('urlRecurso3')">Abrir URL do Campo Acima</button>
                    </div>
                    <p class="note">Exemplo: Um link para um artigo explicativo conciso, um infográfico simples sobre SAAS.</p>
                </div>
            </div>

            <div class="lesson-section">
                <h2>Materiais Necessários para a Aula:</h2>
                <ul>
                    <li>Computador com acesso à internet e projetor.</li>
                    <li>Flipchart ou lousa digital.</li>
                    <li>Link do vídeo sobre meios de pagamento (verificar/atualizar).</li>
                    <li>Links para os recursos visuais/demonstrativos escolhidos (preencher acima).</li>
                </ul>
            </div>

            <div class="lesson-section">
                <h2>Sugestões para Avaliação dos Alunos:</h2>
                <ul>
                    <li>Participação nas discussões e no brainstorming.</li>
                    <li>Qualidade da justificativa para a escolha dos meios de pagamento e forma de integração para o projeto de e-commerce.</li>
                    <li>(Se aplicável) Apresentação do planejamento de integração.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'aulaRecursosColecao';
        let urlCollections = {};

        // Inicializa as coleções ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            loadCollectionsFromStorage();
            populateAllSelects();

            // Sidebar Toggle Functionality
            const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
            const sidebar = document.getElementById('fixed-sidebar');

            if (sidebarToggleButton && sidebar) {
                sidebarToggleButton.addEventListener('click', function() {
                    sidebar.classList.toggle('sidebar-open');
                });
            }

            // Accordion Functionality
            const accordions = document.getElementsByClassName("accordion-header");
            for (let i = 0; i < accordions.length; i++) {
                accordions[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    const panel = this.nextElementSibling;
                    if (panel.style.maxHeight && panel.style.maxHeight !== "0px") {
                        panel.style.maxHeight = null;
                        panel.classList.remove("show");
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                        panel.classList.add("show");
                    }
                });
            }

            // Placeholder for file loading
            const loadConfigInput = document.getElementById('loadConfigInput');
            if (loadConfigInput) {
                loadConfigInput.addEventListener('change', loadPageConfigFromJson, false);
            }
        });

        function loadCollectionsFromStorage() {
            const storedCollections = localStorage.getItem(STORAGE_KEY);
            if (storedCollections) {
                urlCollections = JSON.parse(storedCollections);
            } else {
                // Inicializa se não houver nada no storage
                urlCollections = {
                    'recurso1': [],
                    'recurso2': [],
                    'recurso3': [],
                    'videoRecurso': [], // Adiciona a nova coleção para o vídeo
                    'sidebar_ia': [] // Collection for the IA sidebar button
                };
            }
        }

        function saveCollectionsToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(urlCollections));
        }

        function populateSelect(selectId, resourceKey) {
            const selectElement = document.getElementById(selectId);
            // Check if the element exists before trying to modify it
            if (!selectElement) {
                console.warn(`[populateSelect] Elemento com ID '${selectId}' não encontrado no DOM. Pulando população para este select.`);
                return; // Exit the function if element not found
            }
            selectElement.innerHTML = ''; // Limpa opções existentes ONLY IF element exists
            
            const defaultOptionText = selectElement.id.includes("Recurso1") ? "Links Salvos para Recurso 1..." : 
                                    selectElement.id.includes("Recurso2") ? "Links Salvos para Recurso 2..." : 
                                    selectElement.id.includes("Recurso3") ? "Links Salvos para Recurso 3..." :
                                    selectElement.id.includes("VideoRecurso0") ? "Vídeos Salvos..." : 
                                    selectElement.id.includes("SidebarIA") ? "Links Salvos IA..." : // For the IA sidebar button
                                    selectElement.id.includes("DynRecurso") ? "Links Salvos..." : // For dynamic selects
                                    "Selecione um Link Salvo...";
            
            let firstOption = document.createElement('option');
            firstOption.value = "";
            firstOption.textContent = defaultOptionText;
            selectElement.appendChild(firstOption);

            if (urlCollections[resourceKey]) {
                urlCollections[resourceKey].forEach(item => { // Agora iteramos sobre objetos {name, url}
                    const option = document.createElement('option');
                    option.value = item.url; // O VALOR da option é a URL real
                    option.textContent = item.name; // O TEXTO visível da option é o NOME
                    // Guardar o nome também no dataset para fácil recuperação se necessário
                    option.dataset.name = item.name;
                    selectElement.appendChild(option);
                });
            }
        }

        function populateAllSelects() {
            populateSelect('selectRecurso1', 'recurso1');
            populateSelect('selectRecurso2', 'recurso2');
            populateSelect('selectRecurso3', 'recurso3');
            populateSelect('selectVideoRecurso0', 'videoRecurso'); 
            populateSelect('selectSidebarIA', 'sidebar_ia'); // For the IA sidebar button
        }

        function updateSuggestedVideoUrlFromName() {
            const nameInput = document.getElementById('nameVideoRecurso0');
            const urlInput = document.getElementById('urlVideoRecurso0');
            const searchTerm = nameInput.value.trim();
            if (searchTerm) {
                urlInput.value = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchTerm)}`;
            } else {
                urlInput.value = 'https://www.youtube.com/results?search_query='; // Default search page if name is empty
            }
        }

        function addToCollection(nameInputId, urlInputId, selectId, resourceKey) {
            const nameInput = document.getElementById(nameInputId);
            const urlInput = document.getElementById(urlInputId);
            let name = nameInput.value.trim();
            let contentValue = urlInput.value.trim(); // "contentValue" can be a URL or search term

            if (!contentValue) {
                const alertMessage = resourceKey === 'recurso1' ? "Por favor, insira os termos de busca." : "Por favor, insira uma URL ou termo para adicionar à coleção.";
                alert(alertMessage);
                urlInput.focus();
                return;
            }
            if (!name) { // Se o nome não for fornecido, usar um padrão ou o conteúdo
                name = contentValue.length > 50 ? contentValue.substring(0, 47) + "..." : contentValue; 
            }
            
            let finalContentToStore = contentValue;
            // Para recursos que não são o 'recurso1' (busca) e não são o 'videoRecurso' (que já pode ser uma URL completa)
            // e o conteúdo não parece já ser uma URL completa, prefixar com http://
            if (resourceKey !== 'recurso1' && !/^https?:\/\//i.test(contentValue)) {
                finalContentToStore = 'http://' + contentValue;
                urlInput.value = finalContentToStore; // Atualiza o input da URL com a URL formatada
            } else if (resourceKey === 'recurso1') {
                // Para o recurso1, o valor no input é o termo de busca, não modificar.
            } else {
                 // Para outros casos (como videoRecurso que já pode ser URL completa), manter como está
                 // ou se já era uma URL completa para outros recursos.
            }

            if (!urlCollections[resourceKey]) {
                urlCollections[resourceKey] = [];
            }

            const contentExists = urlCollections[resourceKey].some(item => item.url === finalContentToStore);
            if (contentExists) {
                const alertMessage = resourceKey === 'recurso1' ? "Estes termos de busca já existem na coleção." : "Este conteúdo já existe na coleção para este recurso.";
                alert(alertMessage);
                return;
            }

            urlCollections[resourceKey].push({ name: name, url: finalContentToStore });
            saveCollectionsToStorage();
            populateSelect(selectId, resourceKey);
            
            const successMessage = resourceKey === 'recurso1' ? "Termos de busca salvos na coleção!" : "Link salvo na coleção!";
            alert(successMessage);
            
            nameInput.value = ''; // Limpa o campo de nome após adicionar
            if (resourceKey !== 'recurso1') { // Não limpar o campo de termo de busca para recurso1
                urlInput.value = ''; 
            }
        }

        function loadUrlFromSelect(selectId, urlInputId, nameInputId) {
            const selectElement = document.getElementById(selectId);
            const urlInput = document.getElementById(urlInputId);
            const nameInput = document.getElementById(nameInputId);
            
            if (selectElement.value) {
                urlInput.value = selectElement.value; // selectElement.value é a URL
                // Encontrar o nome correspondente na opção selecionada
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                if (selectedOption && selectedOption.dataset.name) {
                    nameInput.value = selectedOption.dataset.name;
                } else if (selectedOption && selectedOption.value) {
                    // Fallback se o dataset.name não estiver lá por algum motivo (improvável com a lógica atual)
                    nameInput.value = selectedOption.textContent; // O textContent será o nome
                }
            } else {
                // Se a opção default "Links Salvos..." for selecionada, limpar os campos
                urlInput.value = "";
                nameInput.value = "";
            }
        }

        function handleOpenModal(inputId) {
            const urlInput = document.getElementById(inputId);
            const value = urlInput.value.trim();

            if (!value) {
                const alertMessage = inputId === 'urlRecurso1' ? "Por favor, insira os termos de busca." : "Por favor, insira uma URL no campo correspondente.";
                alert(alertMessage);
                urlInput.focus();
                return;
            }
            
            let urlToOpen;
            if (inputId === 'urlRecurso1') { // Special handling for Recurso 1 (Google Search)
                urlToOpen = `https://www.google.com/search?q=${encodeURIComponent(value)}`;
            } else {
                // Existing logic for other resources (direct URLs)
                if (!/^https?:\/\//i.test(value)) {
                    urlToOpen = 'http://' + value;
                } else {
                    urlToOpen = value;
                }
            }
            openUrlInNewWindow(urlToOpen);
        }

        function openUrlInNewWindow(url) {
            const windowWidth = 400;
            const windowHeight = 800;
            const screenWidth = window.screen.width;
            // Tenta posicionar no canto direito. Pode variar dependendo da configuração de múltiplos monitores.
            const windowLeft = screenWidth - windowWidth - 10; // Pequeno offset para não colar totalmente na borda
            const windowTop = 0;

            // Nome da janela (_blank para nova, ou um nome específico para reutilizar se já aberta com esse nome)
            const windowName = '_blank'; // Ou pode ser um nome específico como 'recursoVisualWindow'

            const windowFeatures = `width=${windowWidth},height=${windowHeight},left=${windowLeft},top=${windowTop},resizable=yes,scrollbars=yes`;

            const newWindow = window.open(url, windowName, windowFeatures);

            if (newWindow) {
                newWindow.focus(); // Tenta focar na nova janela
            } else {
                alert("Não foi possível abrir a nova janela. Verifique se o seu navegador está bloqueando pop-ups.");
            }
        }

        function generateModuleContent() {
            // Clear previous dynamic resource collections
            for (const key in urlCollections) {
                if (key.startsWith('dyn_recurso_')) {
                    delete urlCollections[key];
                }
            }
            // It might be good to also clear the select elements themselves if they are not being overwritten
            // However, since lessonWrapper.innerHTML = '' happens next, their HTML structure will be removed.
            // The populateDynamicSelects will recreate them based on new content.

            const rawText = document.getElementById('newModuleTextarea').value;
            if (!rawText.trim()) {
                alert("Por favor, cole o conteúdo do módulo na área de texto.");
                return;
            }

            const mainPageH1 = document.querySelector('.container > h1');
            const mainPageSubtitle = document.querySelector('.container > .page-subtitle');
            const lessonWrapper = document.getElementById('lesson-sections-wrapper');

            if (!mainPageH1 || !mainPageSubtitle || !lessonWrapper) {
                alert("Erro: Elementos da página principal não encontrados para atualização.");
                return;
            }

            // Clear previous content
            lessonWrapper.innerHTML = '';
            mainPageH1.textContent = 'Título da Aula (Aguardando Geração)'; // Placeholder
            mainPageSubtitle.textContent = 'Subtítulo (Aguardando Geração)'; // Placeholder

            const lines = rawText.split(/\r?\n/);
            let htmlContent = '';
            let currentSectionDiv = null;
            let currentUl = false;
            let currentOl = false;
            let inRecursosVisuaisSection = false;
            let dynamicResourceIndex = 0;

            function closeLists() {
                if (currentUl) htmlContent += '</ul>\n';
                if (currentOl) htmlContent += '</ol>\n';
                currentUl = false;
                currentOl = false;
            }
            
            function formatLine(line) {
                line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                line = line.replace(/`(.*?)`/g, '<code>$1</code>');
                return line;
            }

            let titleFound = false;
            for (const line of lines) {
                const trimmedLine = line.trim();

                if (!titleFound && trimmedLine.startsWith('**Módulo')) {
                    const titleMatch = trimmedLine.match(/^\*\*(.*?)(?:\s*–\s*(.*?))?\*\*$/);
                    if (titleMatch) {
                        mainPageH1.textContent = titleMatch[1] ? titleMatch[1].trim() : 'Título da Aula';
                        mainPageSubtitle.textContent = titleMatch[2] ? titleMatch[2].trim() : '';
                        titleFound = true;
                        continue; 
                    }
                }

                const mainSectionHeaderMatch = trimmedLine.match(/^\*\*(\d+\.\s*.*?):\*\*$/);
                if (mainSectionHeaderMatch) {
                    closeLists();
                    if (currentSectionDiv) htmlContent += '</div>\n';
                    htmlContent += '<div class="lesson-section">\n';
                    htmlContent += `  <h2>${formatLine(mainSectionHeaderMatch[1])}</h2>\n`;
                    currentSectionDiv = true;
                    inRecursosVisuaisSection = trimmedLine.toLowerCase().includes("recursos visuais") || trimmedLine.toLowerCase().includes("demonstrações");
                    if (inRecursosVisuaisSection) dynamicResourceIndex = 0; // Reset for new section
                    continue;
                }

                // Dynamic Resource Block Generation (within "Recursos Visuais" section)
                if (inRecursosVisuaisSection && trimmedLine.startsWith('*')) {
                    const resourceMatch = trimmedLine.match(/^\*\s*\*\*Demonstração Visual (\d+):\s*(.*?)\*\*/);
                    if (resourceMatch) {
                        closeLists(); // Should not be in a list itself
                        dynamicResourceIndex = parseInt(resourceMatch[1]); // Use index from text
                        const resourceTitle = formatLine(resourceMatch[2]);
                        let noteText = '';
                        // Check next line for a note (simple check, assumes it's the immediate next line and starts with *)
                        const nextLineIndex = lines.indexOf(line) + 1;
                        if (nextLineIndex < lines.length) {
                            const potentialNoteLine = lines[nextLineIndex].trim();
                            if (potentialNoteLine.startsWith('*')) { // Assuming note also starts with an asterisk or similar marker
                                noteText = formatLine(potentialNoteLine.substring(potentialNoteLine.indexOf('*') + 1).trim());
                            }
                        }

                        htmlContent += '<div class="resource-placeholder">\n';
                        htmlContent += `  <p><strong>Demonstração Visual ${dynamicResourceIndex}: ${resourceTitle}</strong></p>\n`;
                        htmlContent += `  <input type="text" id="nameDynRecurso${dynamicResourceIndex}" class="name-input" placeholder="Nome/Rótulo para o Link">\n`;
                        htmlContent += `  <input type="text" id="urlDynRecurso${dynamicResourceIndex}" class="url-input" placeholder="URL do Link">\n`;
                        htmlContent += '  <div class="collection-management" style="border-top: none; padding-top: 0; margin-bottom: 10px;">\n';
                        htmlContent += `    <button class="add-button" onclick="addToCollection('nameDynRecurso${dynamicResourceIndex}', 'urlDynRecurso${dynamicResourceIndex}', 'selectDynRecurso${dynamicResourceIndex}', 'dyn_recurso_${dynamicResourceIndex}')">Salvar Link Acima na Coleção</button>\n`;
                        htmlContent += `    <label for="selectDynRecurso${dynamicResourceIndex}" style="margin-left: 10px;">Carregar da Coleção:</label>\n`;
                        htmlContent += `    <select id="selectDynRecurso${dynamicResourceIndex}" class="url-select" onchange="loadUrlFromSelect('selectDynRecurso${dynamicResourceIndex}', 'urlDynRecurso${dynamicResourceIndex}', 'nameDynRecurso${dynamicResourceIndex}')"><option value="">Selecione um Link Salvo...</option></select>\n`;
                        htmlContent += '  </div>\n';
                        htmlContent += '  <div class="action-button-group">\n';
                        htmlContent += `    <button class="demo-button" onclick="handleOpenModal('urlDynRecurso${dynamicResourceIndex}')">Abrir URL do Campo Acima</button>\n`;
                        htmlContent += '  </div>\n';
                        if (noteText) {
                            htmlContent += `  <p class="note">${noteText}</p>\n`;
                        } else {
                            htmlContent += '  <p class="note">Exemplo: Link para um vídeo, artigo, imagem ou página de demonstração.</p>\n';
                        }
                        htmlContent += '</div>\n';
                        // If a note was processed from next line, we might want to skip that line in the main loop
                        // For simplicity now, it might get re-processed as a regular list item if not careful with note marker.
                        // The current note check is basic.
                        continue;
                    }
                }

                const etapaMatch = trimmedLine.match(/^\*\s*\*\*(Etapa\s\d+:.*?\s*\(.*\))\*\*$/);
                if (etapaMatch) {
                    closeLists();
                    htmlContent += `  <h3>${formatLine(etapaMatch[1])}</h3>\n`;
                    continue;
                }
                
                // Unordered list items (e.g., *   item)
                if (trimmedLine.startsWith('*')) {
                    if (currentOl) closeLists(); // Close OL if open before starting UL
                    if (!currentUl) {
                        htmlContent += '  <ul>\n';
                        currentUl = true;
                    }
                    htmlContent += `    <li>${formatLine(trimmedLine.substring(trimmedLine.indexOf('*') + 1).trim())}</li>\n`;
                    continue;
                }

                // Ordered list items (e.g., 1.  item)
                const orderedListMatch = trimmedLine.match(/^(\d+)\.\s+(.*)/);
                if (orderedListMatch) {
                    if (currentUl) closeLists(); // Close UL if open before starting OL
                    if (!currentOl) {
                        htmlContent += '  <ol>\n';
                        currentOl = true;
                    }
                    htmlContent += `    <li>${formatLine(orderedListMatch[2])}</li>\n`;
                    continue;
                }

                // If it's not any of the above and is a non-empty line, treat as paragraph
                if (trimmedLine) {
                    closeLists();
                    htmlContent += `  <p>${formatLine(trimmedLine)}</p>\n`;
                } else {
                    // If it's an empty line, it might signify end of a list or paragraph separation
                    closeLists(); 
                }
            }

            closeLists(); // Close any open lists at the end
            if (currentSectionDiv) htmlContent += '</div>\n'; // Close the last section div

            lessonWrapper.innerHTML = htmlContent;
            populateDynamicSelects(); // Call after new HTML is injected
            alert("Conteúdo da aula gerado na página! (Versão com Recursos Dinâmicos)");
        }

        function populateDynamicSelects() {
            const dynamicSelects = document.querySelectorAll('select[id^="selectDynRecurso"]');
            dynamicSelects.forEach(selectElement => {
                const idParts = selectElement.id.match(/selectDynRecurso(\d+)/);
                if (idParts && idParts[1]) {
                    const index = idParts[1];
                    const resourceKey = `dyn_recurso_${index}`;
                    // Ensure this key exists in urlCollections if we are about to populate it
                    // addToCollection handles creation if it doesn't exist when saving.
                    // When loading from JSON, urlCollections will be fully populated.
                    // When generating new content, the collection might be empty initially.
                    if (!urlCollections[resourceKey]) {
                        urlCollections[resourceKey] = [];
                    }
                    populateSelect(selectElement.id, resourceKey);
                }
            });
        }

        // Move these functions to global scope so they are accessible to the button onclick
        function savePageConfigAsJson() {
            const pageState = {
                urlCollections: urlCollections,
                inputs: {
                    nameRecurso1: document.getElementById('nameRecurso1') ? document.getElementById('nameRecurso1').value : '',
                    urlRecurso1: document.getElementById('urlRecurso1') ? document.getElementById('urlRecurso1').value : '',
                    nameRecurso2: document.getElementById('nameRecurso2') ? document.getElementById('nameRecurso2').value : '',
                    urlRecurso2: document.getElementById('urlRecurso2') ? document.getElementById('urlRecurso2').value : '',
                    nameRecurso3: document.getElementById('nameRecurso3') ? document.getElementById('nameRecurso3').value : '',
                    urlRecurso3: document.getElementById('urlRecurso3') ? document.getElementById('urlRecurso3').value : '',
                    nameVideoRecurso0: document.getElementById('nameVideoRecurso0') ? document.getElementById('nameVideoRecurso0').value : '',
                    urlVideoRecurso0: document.getElementById('urlVideoRecurso0') ? document.getElementById('urlVideoRecurso0').value : '',
                    nameSidebarIA: document.getElementById('nameSidebarIA') ? document.getElementById('nameSidebarIA').value : '',
                    urlSidebarIA: document.getElementById('urlSidebarIA') ? document.getElementById('urlSidebarIA').value : '',
                    newModuleTextarea: document.getElementById('newModuleTextarea') ? document.getElementById('newModuleTextarea').value : ''
                },
                dynamicResourceInputs: [],
                lessonHTML: document.getElementById('lesson-sections-wrapper') ? document.getElementById('lesson-sections-wrapper').innerHTML : '',
                planosDeAulaSalvos: {} // Novo campo para os planos de aula
            };

            const dynamicNameInputs = document.querySelectorAll('input[id^="nameDynRecurso"]');
            dynamicNameInputs.forEach(input => {
                const index = input.id.replace('nameDynRecurso', '');
                const urlInput = document.getElementById(`urlDynRecurso${index}`);
                pageState.dynamicResourceInputs.push({
                    idIndex: index,
                    name: input.value,
                    url: urlInput ? urlInput.value : ''
                });
            });

            // Coletar todos os planos de aula do localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('plano_aula_')) {
                    const planoId = key.replace('plano_aula_', '');
                    // Não salvar o plano padrão 'meios_pagamento' explicitamente aqui, ele já faz parte do HTML base.
                    // Ou podemos decidir incluí-lo se a intenção é ter uma cópia exata, mas pode causar confusão.
                    // Por ora, vamos focar nos planos criados pelo usuário.
                    if (planoId !== 'meios_pagamento') { 
                        pageState.planosDeAulaSalvos[planoId] = JSON.parse(localStorage.getItem(key));
                    }
                }
            }

            const jsonData = JSON.stringify(pageState, null, 2);
            const blob = new Blob([jsonData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'configuracao_aula.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Configuração da página salva como configuracao_aula.json");
        }

        function loadPageConfigFromJson(event) {
            console.log("[loadPageConfigFromJson] Iniciando carregamento de configuração JSON...");
            const file = event.target.files[0];
            if (file) {
                console.log("[loadPageConfigFromJson] Arquivo selecionado:", file.name);
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        console.log("[loadPageConfigFromJson] Arquivo lido com sucesso.");
                        const loadedState = JSON.parse(e.target.result);
                        console.log("[loadPageConfigFromJson] Estado carregado do JSON:", loadedState);

                        // Limpar planos de aula existentes no localStorage ANTES de carregar novos
                        console.log("[loadPageConfigFromJson] Limpando planos antigos do localStorage...");
                        let keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('plano_aula_')) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(key => {
                            console.log(`[loadPageConfigFromJson] Removendo chave: ${key}`);
                            localStorage.removeItem(key);
                        });
                        console.log("[loadPageConfigFromJson] Planos antigos removidos.");

                        // Carregar planos de aula do JSON para o localStorage
                        if (loadedState.planosDeAulaSalvos) {
                            console.log("[loadPageConfigFromJson] Carregando planos do JSON para localStorage...");
                            let count = 0;
                            for (const planoId in loadedState.planosDeAulaSalvos) {
                                if (Object.hasOwnProperty.call(loadedState.planosDeAulaSalvos, planoId)) {
                                    const newKey = `plano_aula_${planoId}`;
                                    const planoData = JSON.stringify(loadedState.planosDeAulaSalvos[planoId]);
                                    console.log(`[loadPageConfigFromJson] Salvando plano: ${newKey}`);
                                    localStorage.setItem(newKey, planoData);
                                    count++;
                                }
                            }
                            console.log(`[loadPageConfigFromJson] ${count} planos salvos no localStorage.`);
                        } else {
                            console.log("[loadPageConfigFromJson] Nenhum plano de aula encontrado no JSON (campo planosDeAulaSalvos).");
                        }
                        
                        // Atualizar a lista de planos no dropdown
                        console.log("[loadPageConfigFromJson] Chamando carregarPlanosSalvos() para atualizar dropdown...");
                        carregarPlanosSalvos(); // Esta função já limpa e repopula o select

                        if (loadedState.urlCollections) {
                            urlCollections = loadedState.urlCollections;
                            populateAllSelects();
                            if (loadedState.urlCollections) populateDynamicSelects(); 
                        }
                        
                        if (loadedState.lessonHTML && document.getElementById('lesson-sections-wrapper')) {
                           document.getElementById('lesson-sections-wrapper').innerHTML = loadedState.lessonHTML;
                           // É importante chamar populateDynamicSelects DEPOIS de carregar o lessonHTML
                           // e DEPOIS de carregar urlCollections, para que os selects dinâmicos sejam populados corretamente.
                           if (loadedState.urlCollections) populateDynamicSelects(); 
                        }

                        if (loadedState.inputs) {
                            const inputs = loadedState.inputs;
                            if (document.getElementById('nameRecurso1')) document.getElementById('nameRecurso1').value = inputs.nameRecurso1 || '';
                            if (document.getElementById('urlRecurso1')) document.getElementById('urlRecurso1').value = inputs.urlRecurso1 || '';
                            if (document.getElementById('nameRecurso2')) document.getElementById('nameRecurso2').value = inputs.nameRecurso2 || '';
                            if (document.getElementById('urlRecurso2')) document.getElementById('urlRecurso2').value = inputs.urlRecurso2 || '';
                            if (document.getElementById('nameRecurso3')) document.getElementById('nameRecurso3').value = inputs.nameRecurso3 || '';
                            if (document.getElementById('urlRecurso3')) document.getElementById('urlRecurso3').value = inputs.urlRecurso3 || '';
                            if (document.getElementById('nameVideoRecurso0')) document.getElementById('nameVideoRecurso0').value = inputs.nameVideoRecurso0 || '';
                            if (document.getElementById('urlVideoRecurso0')) document.getElementById('urlVideoRecurso0').value = inputs.urlVideoRecurso0 || '';
                            if (document.getElementById('nameSidebarIA')) document.getElementById('nameSidebarIA').value = inputs.nameSidebarIA || '';
                            if (document.getElementById('urlSidebarIA')) document.getElementById('urlSidebarIA').value = inputs.urlSidebarIA || '';
                            if (document.getElementById('newModuleTextarea')) document.getElementById('newModuleTextarea').value = inputs.newModuleTextarea || '';

                            if (inputs.dynamicResourceInputs && Array.isArray(inputs.dynamicResourceInputs)) {
                                inputs.dynamicResourceInputs.forEach(dynInputData => {
                                    const nameField = document.getElementById(`nameDynRecurso${dynInputData.idIndex}`);
                                    const urlField = document.getElementById(`urlDynRecurso${dynInputData.idIndex}`);
                                    if (nameField) nameField.value = dynInputData.name || '';
                                    if (urlField) urlField.value = dynInputData.url || '';
                                });
                            }
                        }

                        alert("Arquivo de plano carregado e aplicado com sucesso!");

                    } catch (error) {
                        alert("Erro ao carregar o arquivo de plano: " + error);
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = null; // Reset file input
        }

        // Função para carregar planos pré-configurados
        function carregarPlanoPreConfigurado() {
            const seletor = document.getElementById('planoPreConfigurado');
            const planoSelecionado = seletor.value; // Este é o ID, ex: 'logistica_ecommerce'
            const valorAnteriorDoSeletor = seletor.value; // Guardar o valor atual para possível reversão
            
            if (!planoSelecionado) {
                alert("Por favor, selecione um plano de aula.");
                return;
            }
            
            console.log(`[carregarPlanoPreConfigurado] Tentando carregar o plano: ${planoSelecionado}`);
            document.querySelector('.container > h1').textContent = "Carregando plano...";
            document.querySelector('.container > .page-subtitle').textContent = "Por favor, aguarde...";
            
            const chave = `plano_aula_${planoSelecionado}`;
            const dadosPlanoArmazenado = localStorage.getItem(chave);
            
            if (dadosPlanoArmazenado) {
                try {
                    console.log(`[carregarPlanoPreConfigurado] Dados encontrados no localStorage para ${chave}.`);
                    const data = JSON.parse(dadosPlanoArmazenado);
                    aplicarDadosPlano(data, planoSelecionado);
                } catch (error) {
                    console.error("[carregarPlanoPreConfigurado] Erro ao processar dados do plano do localStorage:", error);
                    alert("Erro ao processar os dados do plano.");
                    document.querySelector('.container > h1').textContent = "Erro ao carregar";
                    document.querySelector('.container > .page-subtitle').textContent = "Tente novamente.";
                    seletor.value = valorAnteriorDoSeletor; // Reverter seleção em caso de erro
                }
            } else {
                if (planoSelecionado === "meios_pagamento") {
                    console.log("[carregarPlanoPreConfigurado] Plano 'meios_pagamento' (padrão) selecionado. Solicitando recarregamento.");
                    if (confirm("Este plano será carregado do modelo padrão. A página será recarregada. Continuar?")) {
                        location.reload();
                    } else {
                        document.querySelector('.container > h1').textContent = "Operação cancelada";
                        document.querySelector('.container > .page-subtitle').textContent = "Selecione outra opção.";
                        seletor.value = ""; // Resetar para "Escolha um plano..."
                    }
                } else {
                    console.warn(`[carregarPlanoPreConfigurado] Plano '${planoSelecionado}' (chave: ${chave}) não encontrado no armazenamento local.`);
                    alert(`Plano "${planoSelecionado}" não encontrado no armazenamento local.`);
                    document.querySelector('.container > h1').textContent = "Plano não encontrado";
                    document.querySelector('.container > .page-subtitle').textContent = "Tente outro plano.";
                    seletor.value = valorAnteriorDoSeletor; // Reverter para seleção anterior
                }
            }
        }

        // Função para aplicar os dados de um plano carregado
        function aplicarDadosPlano(data, planoId) { 
            console.log("[aplicarDadosPlano] Iniciando aplicação dos dados para o planoId:", planoId, "Dados recebidos:", JSON.parse(JSON.stringify(data)));

            // 0. Limpar inputs estáticos antes de aplicar novos valores
            console.log("[aplicarDadosPlano] Limpando valores de inputs estáticos...");
            const staticInputIds = ['nameRecurso1', 'urlRecurso1', 'nameRecurso2', 'urlRecurso2', 'nameRecurso3', 'urlRecurso3', 'nameVideoRecurso0', 'urlVideoRecurso0', 'nameSidebarIA', 'urlSidebarIA', 'newModuleTextarea'];
            staticInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });

            // 1. Atualizar as coleções de URLs GLOBAIS e popular os selects ESTÁTICOS
            console.log("[aplicarDadosPlano] Etapa 1: Processando urlCollections e selects estáticos.");
            if (data.urlCollections) {
                urlCollections = data.urlCollections; // Atualiza a variável global
                console.log("[aplicarDadosPlano] urlCollections globais atualizadas.", urlCollections);
            } else {
                console.warn("[aplicarDadosPlano] data.urlCollections não encontrado no plano. As urlCollections globais não foram alteradas.");
                // Considerar limpar urlCollections se este for o comportamento desejado: 
                // urlCollections = { 'recurso1': [], 'recurso2': [], 'recurso3': [], 'videoRecurso': [], 'sidebar_ia': [], /* etc para dyn_* */ };
            }
            populateAllSelects(); // Popula selects estáticos (Recurso1,2,3, Video, IA) com base nas urlCollections atuais
            console.log("[aplicarDadosPlano] Selects estáticos (Rec1,2,3,Video,IA) repopulados.");
            
            // 2. Atualizar o conteúdo HTML da aula
            console.log("[aplicarDadosPlano] Etapa 2: Aplicando lessonHTML.");
            const lessonWrapper = document.getElementById('lesson-sections-wrapper');
            if (data.lessonHTML && lessonWrapper) {
                lessonWrapper.innerHTML = data.lessonHTML;
                console.log("[aplicarDadosPlano] lessonHTML aplicado ao lesson-sections-wrapper.");
            } else {
                console.warn("[aplicarDadosPlano] data.lessonHTML não encontrado ou lesson-sections-wrapper não existe.");
                if (lessonWrapper) {
                    lessonWrapper.innerHTML = '<p style="color:red; font-style:italic;">Conteúdo detalhado deste plano não disponível ou não encontrado nos dados carregados.</p>';
                    console.log("[aplicarDadosPlano] Mensagem de conteúdo não disponível inserida.");
                }
            }
            
            // 3. Repopular os selects DINÂMICOS (agora que o HTML está no DOM e urlCollections está atualizada)
            console.log("[aplicarDadosPlano] Etapa 3: Chamando populateDynamicSelects() para os selects dentro do lessonHTML...");
            populateDynamicSelects(); 
            console.log("[aplicarDadosPlano] populateDynamicSelects() concluído.");

            // 4. Atualizar os valores dos inputs (estáticos e dinâmicos)
            console.log("[aplicarDadosPlano] Etapa 4: Aplicando valores dos inputs salvos...");
            if (data.inputs) {
                const inputs = data.inputs;
                // Inputs estáticos
                if (document.getElementById('nameRecurso1')) document.getElementById('nameRecurso1').value = inputs.nameRecurso1 || '';
                if (document.getElementById('urlRecurso1')) document.getElementById('urlRecurso1').value = inputs.urlRecurso1 || '';
                if (document.getElementById('nameRecurso2')) document.getElementById('nameRecurso2').value = inputs.nameRecurso2 || '';
                if (document.getElementById('urlRecurso2')) document.getElementById('urlRecurso2').value = inputs.urlRecurso2 || '';
                if (document.getElementById('nameRecurso3')) document.getElementById('nameRecurso3').value = inputs.nameRecurso3 || '';
                if (document.getElementById('urlRecurso3')) document.getElementById('urlRecurso3').value = inputs.urlRecurso3 || '';
                if (document.getElementById('nameVideoRecurso0')) document.getElementById('nameVideoRecurso0').value = inputs.nameVideoRecurso0 || '';
                if (document.getElementById('urlVideoRecurso0')) document.getElementById('urlVideoRecurso0').value = inputs.urlVideoRecurso0 || '';
                if (document.getElementById('nameSidebarIA')) document.getElementById('nameSidebarIA').value = inputs.nameSidebarIA || '';
                if (document.getElementById('urlSidebarIA')) document.getElementById('urlSidebarIA').value = inputs.urlSidebarIA || '';
                if (document.getElementById('newModuleTextarea')) document.getElementById('newModuleTextarea').value = inputs.newModuleTextarea || '';
                console.log("[aplicarDadosPlano] Inputs estáticos preenchidos.");

                // Inputs dinâmicos (os elementos foram recriados pelo innerHTML)
                if (inputs.dynamicResourceInputs && Array.isArray(inputs.dynamicResourceInputs)) {
                    console.log("[aplicarDadosPlano] Aplicando valores para inputs de recursos dinâmicos:", inputs.dynamicResourceInputs);
                    inputs.dynamicResourceInputs.forEach(dynInputData => {
                        const nameField = document.getElementById(`nameDynRecurso${dynInputData.idIndex}`);
                        const urlField = document.getElementById(`urlDynRecurso${dynInputData.idIndex}`);
                        if (nameField) {
                            nameField.value = dynInputData.name || '';
                        } else {
                            console.warn(`[aplicarDadosPlano] Campo de nome dinâmico nameDynRecurso${dynInputData.idIndex} não encontrado no DOM após carregar lessonHTML.`);
                        }
                        if (urlField) {
                            urlField.value = dynInputData.url || '';
                        } else {
                            console.warn(`[aplicarDadosPlano] Campo de URL dinâmica urlDynRecurso${dynInputData.idIndex} não encontrado no DOM após carregar lessonHTML.`);
                        }
                    });
                    console.log("[aplicarDadosPlano] Inputs dinâmicos preenchidos.");
                }
            } else {
                 console.warn("[aplicarDadosPlano] data.inputs não encontrado no plano. Inputs não foram preenchidos com dados do plano.");
            }
            
            // 5. Atualizar título da página
            console.log("[aplicarDadosPlano] Etapa 5: Atualizando título e subtítulo.");
            const h1Element = document.querySelector('.container > h1');
            if (data.pageTitle) {
                h1Element.textContent = data.pageTitle;
            } else if (planoId) { 
                const seletor = document.getElementById('planoPreConfigurado');
                let tituloPlanoDropdown = `Plano: ${planoId}`; // Fallback com ID
                if (seletor) {
                    for (let i = 0; i < seletor.options.length; i++) {
                        if (seletor.options[i].value === planoId) {
                            tituloPlanoDropdown = seletor.options[i].text; // Usa o texto do dropdown se disponível
                            break;
                        }
                    }
                }
                h1Element.textContent = tituloPlanoDropdown;
            } else {
                h1Element.textContent = "Título do Plano Indefinido"; // Fallback genérico
            }
            
            const subtitleElement = document.querySelector('.container > .page-subtitle');
            if (data.pageSubtitle) {
                subtitleElement.textContent = data.pageSubtitle;
            } else {
                subtitleElement.textContent = "(Subtítulo não definido no plano)"; // Fallback claro
            }
            console.log("[aplicarDadosPlano] Título da página atualizado para:", h1Element.textContent);
            console.log("[aplicarDadosPlano] Subtítulo da página atualizado para:", subtitleElement.textContent);
            
            console.log("[aplicarDadosPlano] Aplicação dos dados do plano concluída.");
            alert("Plano de aula carregado e aplicado à página!"); 
        }

        // Salvar o plano atual como um novo plano
        function salvarComoNovoPlano() {
            const nomePlano = prompt("Digite um identificador único para este plano (sem espaços, apenas letras e números):");
            
            if (!nomePlano) return; // Usuário cancelou
            
            // Validar o nome do plano (apenas letras, números e underscores)
            if (!/^[a-z0-9_]+$/i.test(nomePlano)) {
                alert("O identificador deve conter apenas letras, números e underscores.");
                return;
            }
            
            const tituloPlano = prompt("Digite o título completo do plano:", document.querySelector('.container > h1').textContent);
            if (!tituloPlano) return; // Usuário cancelou
            
            const subtituloPlano = prompt("Digite o subtítulo do plano:", document.querySelector('.page-subtitle').textContent);
            
            // Criar objeto com os dados do plano
            const pageState = {
                urlCollections: urlCollections,
                inputs: {
                    nameRecurso1: document.getElementById('nameRecurso1') ? document.getElementById('nameRecurso1').value : '',
                    urlRecurso1: document.getElementById('urlRecurso1') ? document.getElementById('urlRecurso1').value : '',
                    nameRecurso2: document.getElementById('nameRecurso2') ? document.getElementById('nameRecurso2').value : '',
                    urlRecurso2: document.getElementById('urlRecurso2') ? document.getElementById('urlRecurso2').value : '',
                    nameRecurso3: document.getElementById('nameRecurso3') ? document.getElementById('nameRecurso3').value : '',
                    urlRecurso3: document.getElementById('urlRecurso3') ? document.getElementById('urlRecurso3').value : '',
                    nameVideoRecurso0: document.getElementById('nameVideoRecurso0') ? document.getElementById('nameVideoRecurso0').value : '',
                    urlVideoRecurso0: document.getElementById('urlVideoRecurso0') ? document.getElementById('urlVideoRecurso0').value : '',
                    nameSidebarIA: document.getElementById('nameSidebarIA') ? document.getElementById('nameSidebarIA').value : '',
                    urlSidebarIA: document.getElementById('urlSidebarIA') ? document.getElementById('urlSidebarIA').value : '',
                    newModuleTextarea: document.getElementById('newModuleTextarea') ? document.getElementById('newModuleTextarea').value : '',
                    dynamicResourceInputs: [] // Inicializa o array aqui
                },
                lessonHTML: document.getElementById('lesson-sections-wrapper') ? document.getElementById('lesson-sections-wrapper').innerHTML : '',
                pageTitle: tituloPlano,
                pageSubtitle: subtituloPlano
            };
            
            // Adicionar recursos dinâmicos, se existirem
            const dynamicNameInputs = document.querySelectorAll('input[id^="nameDynRecurso"]');
            dynamicNameInputs.forEach(input => {
                const index = input.id.replace('nameDynRecurso', '');
                const urlInput = document.getElementById(`urlDynRecurso${index}`);
                pageState.inputs.dynamicResourceInputs.push({
                    idIndex: index,
                    name: input.value,
                    url: urlInput ? urlInput.value : ''
                });
            });
            
            // Salvar no localStorage
            const chave = `plano_aula_${nomePlano}`;
            localStorage.setItem(chave, JSON.stringify(pageState));
            
            // Atualizar a lista de planos disponíveis
            carregarPlanosSalvos();
            
            // Selecionar o novo plano no dropdown
            const seletor = document.getElementById('planoPreConfigurado');
            seletor.value = nomePlano;
            
            alert(`Plano "${tituloPlano}" salvo com sucesso!`);
        }
        
        // Função para exportar plano atual como arquivo local
        function exportarPlanoLocal() {
            console.log("Função exportar plano iniciada");
            const tituloAtual = document.querySelector('.container > h1').textContent;
            const subtituloAtual = document.querySelector('.page-subtitle').textContent;
            
            // Criar objeto com os dados do plano atual
            const pageState = {
                urlCollections: urlCollections,
                inputs: {
                    nameRecurso1: document.getElementById('nameRecurso1') ? document.getElementById('nameRecurso1').value : '',
                    urlRecurso1: document.getElementById('urlRecurso1') ? document.getElementById('urlRecurso1').value : '',
                    nameRecurso2: document.getElementById('nameRecurso2') ? document.getElementById('nameRecurso2').value : '',
                    urlRecurso2: document.getElementById('urlRecurso2') ? document.getElementById('urlRecurso2').value : '',
                    nameRecurso3: document.getElementById('nameRecurso3') ? document.getElementById('nameRecurso3').value : '',
                    urlRecurso3: document.getElementById('urlRecurso3') ? document.getElementById('urlRecurso3').value : '',
                    nameVideoRecurso0: document.getElementById('nameVideoRecurso0') ? document.getElementById('nameVideoRecurso0').value : '',
                    urlVideoRecurso0: document.getElementById('urlVideoRecurso0') ? document.getElementById('urlVideoRecurso0').value : '',
                    nameSidebarIA: document.getElementById('nameSidebarIA') ? document.getElementById('nameSidebarIA').value : '',
                    urlSidebarIA: document.getElementById('urlSidebarIA') ? document.getElementById('urlSidebarIA').value : '',
                    newModuleTextarea: document.getElementById('newModuleTextarea') ? document.getElementById('newModuleTextarea').value : ''
                },
                dynamicResourceInputs: [],
                lessonHTML: document.getElementById('lesson-sections-wrapper') ? document.getElementById('lesson-sections-wrapper').innerHTML : '',
                pageTitle: tituloAtual,
                pageSubtitle: subtituloAtual
            };
            
            // Adicionar recursos dinâmicos, se existirem
            const dynamicNameInputs = document.querySelectorAll('input[id^="nameDynRecurso"]');
            dynamicNameInputs.forEach(input => {
                const index = input.id.replace('nameDynRecurso', '');
                const urlInput = document.getElementById(`urlDynRecurso${index}`);
                if (!pageState.inputs.dynamicResourceInputs) {
                    pageState.inputs.dynamicResourceInputs = [];
                }
                pageState.inputs.dynamicResourceInputs.push({
                    idIndex: index,
                    name: input.value,
                    url: urlInput ? urlInput.value : ''
                });
            });
            
            try {
                // Gerar o arquivo para download
                const jsonData = JSON.stringify(pageState, null, 2);
                const blob = new Blob([jsonData], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                // Criar elemento de link para download
                const a = document.createElement('a');
                a.href = url;
                
                // Criar um nome de arquivo baseado no título
                let nomeArquivo = tituloAtual.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '_') // Substituir caracteres não alfanuméricos por _
                    .replace(/^_+|_+$/g, '') // Remover _ do início e fim
                    || 'plano_aula';
                    
                a.download = `${nomeArquivo}.json`;
                
                // Adicionar à página, clicar e remover
                document.body.appendChild(a);
                a.click();
                
                // Pequeno atraso antes de remover para garantir que o download comece
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert("Plano exportado com sucesso!");
                }, 100);
            } catch (error) {
                console.error("Erro ao exportar plano:", error);
                alert("Erro ao exportar plano: " + error.message);
            }
        }
    
        // Evento para carregar arquivo de plano personalizado
        document.addEventListener('DOMContentLoaded', function() {
            const loadConfigInput = document.getElementById('loadConfigInput');
            if (loadConfigInput) {
                loadConfigInput.addEventListener('change', loadPageConfigFromJson, false);
            }
            
            const carregarPlanoInput = document.getElementById('carregarPlanoInput');
            if (carregarPlanoInput) {
                carregarPlanoInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const loadedState = JSON.parse(e.target.result);
                                aplicarDadosPlano(loadedState, '');
                            } catch (error) {
                                alert("Erro ao carregar o arquivo de plano: " + error);
                            }
                        };
                        reader.readAsText(file);
                    }
                    event.target.value = null; // Reset file input
                }, false);
            }
            
            // Carregar planos salvos do localStorage
            carregarPlanosSalvos();
        });
        
        // Função para carregar planos salvos no localStorage
        function carregarPlanosSalvos() {
            console.log("[carregarPlanosSalvos] Iniciando carregamento de planos para o dropdown...");
            const seletor = document.getElementById('planoPreConfigurado');
            if (!seletor) {
                console.error("[carregarPlanosSalvos] Erro: Seletor 'planoPreConfigurado' não encontrado!");
                return;
            }
            
            // Manter apenas a opção padrão vazia e a opção meios_pagamento
            console.log("[carregarPlanosSalvos] Limpando opções antigas do dropdown (exceto as 2 primeiras). Opções atuais:", seletor.options.length);
            while (seletor.options.length > 2) {
                seletor.remove(2);
            }
            console.log("[carregarPlanosSalvos] Opções após limpeza:", seletor.options.length);
            
            // Lista para armazenar os planos antes de adicioná-los ao seletor
            let planos = [];
            
            // Procurar planos no localStorage
            console.log("[carregarPlanosSalvos] Procurando planos no localStorage... Itens totais:", localStorage.length);
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // console.log("[carregarPlanosSalvos] Verificando chave:", key); // Log muito verboso, comentado por padrão
                
                if (key && key.startsWith('plano_aula_') && key !== 'plano_aula_meios_pagamento') {
                    try {
                        const planoData = JSON.parse(localStorage.getItem(key));
                        const planoId = key.replace('plano_aula_', '');
                        const planoTitulo = planoData.pageTitle || planoId;
                        const ordem = planoData.ordem || 999; // Valor alto para planos sem ordem definida
                        
                        console.log(`[carregarPlanosSalvos] Plano encontrado no localStorage: ID=${planoId}, Título='${planoTitulo}', Ordem=${ordem}`);
                        
                        // Adicionar à lista de planos com ordem (se existir) ou posição padrão
                        planos.push({
                            id: planoId,
                            titulo: planoTitulo,
                            ordem: ordem
                        });
                    } catch(e) {
                        console.error(`[carregarPlanosSalvos] Erro ao processar plano ${key}:`, e);
                    }
                }
            }
            console.log(`[carregarPlanosSalvos] Total de planos encontrados no localStorage (exceto padrão): ${planos.length}`);
            
            // Ordenar os planos pela propriedade ordem
            planos.sort((a, b) => a.ordem - b.ordem);
            console.log("[carregarPlanosSalvos] Planos ordenados:", planos);
            
            // Adicionar os planos ordenados ao seletor
            console.log("[carregarPlanosSalvos] Adicionando planos ordenados ao dropdown...");
            planos.forEach(plano => {
                const novaOpcao = document.createElement('option');
                novaOpcao.value = plano.id;
                novaOpcao.textContent = plano.titulo;
                seletor.appendChild(novaOpcao);
                // console.log("[carregarPlanosSalvos] Opção adicionada ao dropdown:", plano.id); // Log verboso
            });
            
            console.log("[carregarPlanosSalvos] Carregamento concluído. Total de opções final no dropdown:", seletor.options.length);
        }

        // Adicionar chamada inicial para carregarPlanosSalvos()
        document.addEventListener('DOMContentLoaded', function() {
            // Código existente...
            
            // Garantir que os planos sejam carregados quando a página iniciar
            carregarPlanosSalvos();
        });

        // Função para remover um plano selecionado do localStorage
        function removerPlanoSelecionado() {
            const seletor = document.getElementById('planoPreConfigurado');
            const planoSelecionado = seletor.value;
            
            if (!planoSelecionado) {
                alert("Por favor, selecione um plano para remover.");
                return;
            }
            
            // Verificar se não é o plano padrão
            if (planoSelecionado === "meios_pagamento") {
                alert("O plano padrão não pode ser removido.");
                return;
            }
            
            const confirmacao = confirm(`Tem certeza que deseja remover o plano "${seletor.options[seletor.selectedIndex].text}"? Esta ação não pode ser desfeita.`);
            
            if (confirmacao) {
                // Remover do localStorage
                localStorage.removeItem(`plano_aula_${planoSelecionado}`);
                
                // Recarregar a lista de planos
                carregarPlanosSalvos();
                
                alert("Plano removido com sucesso!");
            }
        }
        
        // Função para mover um plano para cima na ordem
        function moverPlanoParaCima() {
            const seletor = document.getElementById('planoPreConfigurado');
            const selectedIndex = seletor.selectedIndex;
            
            // Verificar se há um plano selecionado e se não é o primeiro ou o plano em branco
            if (selectedIndex <= 1) {
                alert("Este plano já está no topo ou nenhum plano foi selecionado.");
                return;
            }
            
            // Obter informações dos planos que serão trocados
            const planoAtual = {
                valor: seletor.options[selectedIndex].value,
                texto: seletor.options[selectedIndex].text
            };
            
            const planoAnterior = {
                valor: seletor.options[selectedIndex - 1].value,
                texto: seletor.options[selectedIndex - 1].text
            };
            
            // Para alterar a ordem, vamos adicionar uma propriedade de ordenação aos planos
            // Primeiro, vamos carregar os planos
            const planoAtualData = JSON.parse(localStorage.getItem(`plano_aula_${planoAtual.valor}`));
            const planoAnteriorData = JSON.parse(localStorage.getItem(`plano_aula_${planoAnterior.valor}`));
            
            // Criar ou trocar a propriedade ordem
            if (!planoAtualData.ordem) planoAtualData.ordem = selectedIndex;
            if (!planoAnteriorData.ordem) planoAnteriorData.ordem = selectedIndex - 1;
            
            // Trocar as ordens
            const tempOrdem = planoAtualData.ordem;
            planoAtualData.ordem = planoAnteriorData.ordem;
            planoAnteriorData.ordem = tempOrdem;
            
            // Salvar de volta
            localStorage.setItem(`plano_aula_${planoAtual.valor}`, JSON.stringify(planoAtualData));
            localStorage.setItem(`plano_aula_${planoAnterior.valor}`, JSON.stringify(planoAnteriorData));
            
            // Recarregar a lista
            carregarPlanosSalvos();
            
            // Reselecionar o plano que foi movido
            seletor.value = planoAtual.valor;
        }
        
        // Função para mover um plano para baixo na ordem
        function moverPlanoParaBaixo() {
            const seletor = document.getElementById('planoPreConfigurado');
            const selectedIndex = seletor.selectedIndex;
            
            // Verificar se há um plano selecionado e se não é o último
            if (selectedIndex < 1 || selectedIndex >= seletor.options.length - 1) {
                alert("Este plano já está no final da lista ou nenhum plano foi selecionado.");
                return;
            }
            
            // Obter informações dos planos que serão trocados
            const planoAtual = {
                valor: seletor.options[selectedIndex].value,
                texto: seletor.options[selectedIndex].text
            };
            
            const proximoPlano = {
                valor: seletor.options[selectedIndex + 1].value,
                texto: seletor.options[selectedIndex + 1].text
            };
            
            // Para alterar a ordem, vamos adicionar uma propriedade de ordenação aos planos
            // Primeiro, vamos carregar os planos
            const planoAtualData = JSON.parse(localStorage.getItem(`plano_aula_${planoAtual.valor}`));
            const proximoPlanoData = JSON.parse(localStorage.getItem(`plano_aula_${proximoPlano.valor}`));
            
            // Criar ou trocar a propriedade ordem
            if (!planoAtualData.ordem) planoAtualData.ordem = selectedIndex;
            if (!proximoPlanoData.ordem) proximoPlanoData.ordem = selectedIndex + 1;
            
            // Trocar as ordens
            const tempOrdem = planoAtualData.ordem;
            planoAtualData.ordem = proximoPlanoData.ordem;
            proximoPlanoData.ordem = tempOrdem;
            
            // Salvar de volta
            localStorage.setItem(`plano_aula_${planoAtual.valor}`, JSON.stringify(planoAtualData));
            localStorage.setItem(`plano_aula_${proximoPlano.valor}`, JSON.stringify(proximoPlanoData));
            
            // Recarregar a lista
            carregarPlanosSalvos();
            
            // Reselecionar o plano que foi movido
            seletor.value = planoAtual.valor;
        }
    </script>

    <!-- Tutorial Interativo -->
    <script>
    // Tutorial Interativo para Sistema de Planos de Aula
    // Este script cria um tour guiado passo a passo para usuários iniciantes

    const tutorialInterativo = {
        ativo: false,
        passoAtual: 0,
        tutorial: null,
        overlay: null,
        
        // Definição das etapas do tutorial
        passos: [
            {
                titulo: "Bem-vindo ao Sistema de Planos de Aula!",
                descricao: "Este tutorial rápido vai mostrar como usar as principais funcionalidades do sistema. Clique em 'Próximo' para continuar.",
                elemento: "body",
                posicao: "centro",
                destacar: false
            },
            {
                titulo: "Barra Lateral",
                descricao: "Esta é a barra lateral onde você encontra as principais ferramentas para criar e gerenciar seus planos de aula.",
                elemento: "#fixed-sidebar",
                posicao: "direita",
                destacar: true
            },
            {
                titulo: "Novo Conteúdo",
                descricao: "Clique aqui para abrir o painel onde você irá colar seu texto de plano de aula.",
                elemento: ".accordion-header",
                posicao: "direita",
                destacar: true,
                acao: function() {
                    // Abrir o acordeão se não estiver aberto
                    const painel = document.querySelector('.accordion-panel');
                    if (painel && !painel.classList.contains('show')) {
                        document.querySelector('.accordion-header').click();
                    }
                }
            },
            {
                titulo: "Cole seu texto aqui",
                descricao: "Cole o texto do seu plano de aula neste campo. O sistema reconhece formatos específicos como títulos, listas e recursos visuais.",
                elemento: "#newModuleTextarea",
                posicao: "direita",
                destacar: true
            },
            {
                titulo: "Gerar Conteúdo",
                descricao: "Após colar seu texto, clique neste botão para transformá-lo em um plano formatado.",
                elemento: ".accordion-panel .demo-button",
                posicao: "direita",
                destacar: true
            },
            {
                titulo: "Recursos Visuais",
                descricao: "Quando seu plano for gerado, você terá blocos como este para adicionar links e recursos visuais para cada demonstração.",
                elemento: ".resource-placeholder",
                posicao: "abaixo",
                destacar: true
            },
            {
                titulo: "Adicionar Recursos",
                descricao: "Digite um nome e URL para o recurso, depois clique em 'Salvar Link Acima na Coleção' para guardá-lo para uso futuro.",
                elemento: ".add-button",
                posicao: "acima",
                destacar: true
            },
            {
                titulo: "Salvar Configuração",
                descricao: "Quando terminar de criar seu plano, clique aqui para salvar toda a configuração em um arquivo JSON que pode ser carregado posteriormente.",
                elemento: "button[onclick='savePageConfigAsJson()']",
                posicao: "esquerda",
                destacar: true
            },
            {
                titulo: "Parabéns!",
                descricao: "Você concluiu o tutorial básico. Agora você está pronto para criar seus próprios planos de aula interativos. Você pode rever este tutorial a qualquer momento clicando no botão 'Tutorial' que será adicionado à barra lateral.",
                elemento: "body",
                posicao: "centro",
                destacar: false
            }
        ],
        
        // Inicializa o tutorial
        iniciar: function() {
            if (this.tutorial) return; // Evita iniciar duas vezes
            
            this.ativo = true;
            this.passoAtual = 0;
            this.criarElementos();
            this.mostrarPasso(0);
            
            // Adiciona o botão de tutorial permanente na barra lateral
            this.adicionarBotaoTutorial();
        },
        
        // Cria os elementos necessários para o tutorial
        criarElementos: function() {
            // Overlay semi-transparente
            this.overlay = document.createElement('div');
            this.overlay.className = 'tutorial-overlay';
            
            // Container do tutorial
            this.tutorial = document.createElement('div');
            this.tutorial.className = 'tutorial-container';
            
            // Estilo para os elementos
            const style = document.createElement('style');
            style.textContent = `
                .tutorial-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.6);
                    z-index: 9998;
                    pointer-events: none;
                }
                
                .tutorial-container {
                    position: fixed;
                    background-color: white;
                    border-radius: 8px;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
                    padding: 20px;
                    max-width: 400px;
                    z-index: 9999;
                    pointer-events: auto;
                }
                
                .tutorial-titulo {
                    font-size: 1.2em;
                    color: #3498db;
                    margin-top: 0;
                    margin-bottom: 10px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #eee;
                    padding-right: 25px; /* Espaço para o botão fechar */
                }
                
                .tutorial-descricao {
                    margin-bottom: 20px;
                    font-size: 0.95em;
                    line-height: 1.4;
                }
                
                .tutorial-botoes {
                    display: flex;
                    justify-content: space-between;
                }
                
                .tutorial-botao {
                    padding: 8px 15px;
                    border-radius: 4px;
                    border: none;
                    cursor: pointer;
                    font-size: 0.9em;
                }
                
                .tutorial-botao-anterior {
                    background-color: #e0e0e0;
                    color: #555;
                }
                
                .tutorial-botao-proximo {
                    background-color: #3498db;
                    color: white;
                }
                
                .tutorial-botao-fechar {
                    background-color: #e74c3c;
                    color: white;
                }
                
                /* Botão X para fechar a qualquer momento */
                .tutorial-fechar-x {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    line-height: 1;
                    color: #999;
                    cursor: pointer;
                    padding: 0;
                }
                
                .tutorial-fechar-x:hover {
                    color: #e74c3c;
                }
                
                /* Timeline de passos do tutorial */
                .tutorial-timeline {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin: 15px 0;
                    flex-wrap: wrap;
                }
                
                .tutorial-ponto {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background-color: #ccc;
                    margin: 0 4px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .tutorial-ponto:hover {
                    background-color: #95a5a6;
                    transform: scale(1.2);
                }
                
                .tutorial-ponto.ativo {
                    background-color: #3498db;
                    transform: scale(1.3);
                }

                .tutorial-elemento-destacado {
                    position: relative;
                    z-index: 9999;
                    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.8);
                    border-radius: 3px;
                }
                
                .tutorial-botao-sidebar {
                    background-color: #2ecc71;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 15px;
                    font-weight: bold;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(this.overlay);
            document.body.appendChild(this.tutorial);
        },
        
        // Mostra um passo específico do tutorial
        mostrarPasso: function(index) {
            if (!this.tutorial || index < 0 || index >= this.passos.length) return;
            
            // Limpa destaque anterior
            const elementoAnterior = document.querySelector('.tutorial-elemento-destacado');
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-elemento-destacado');
            }
            
            const passo = this.passos[index];
            this.passoAtual = index;
            
            // HTML do tutorial
            let tutorialHTML = `
                <button class="tutorial-fechar-x" onclick="tutorialInterativo.fechar()">&times;</button>
                <h3 class="tutorial-titulo">${passo.titulo}</h3>
                <p class="tutorial-descricao">${passo.descricao}</p>
                <div class="tutorial-timeline">
            `;
            
            // Adiciona a timeline de pontos para navegação direta
            for (let i = 0; i < this.passos.length; i++) {
                const classeAtivo = i === index ? 'ativo' : '';
                tutorialHTML += `<div class="tutorial-ponto ${classeAtivo}" onclick="tutorialInterativo.mostrarPasso(${i})" title="Passo ${i+1}"></div>`;
            }
            
            tutorialHTML += `</div>`;
            tutorialHTML += `<div class="tutorial-botoes">`;
            
            // Botão anterior (exceto no primeiro passo)
            if (index > 0) {
                tutorialHTML += `<button class="tutorial-botao tutorial-botao-anterior" onclick="tutorialInterativo.passoAnterior()">Anterior</button>`;
            } else {
                tutorialHTML += `<div></div>`;
            }
            
            // Botão próximo (ou finalizar no último passo)
            if (index < this.passos.length - 1) {
                tutorialHTML += `<button class="tutorial-botao tutorial-botao-proximo" onclick="tutorialInterativo.proximoPasso()">Próximo</button>`;
            } else {
                tutorialHTML += `<button class="tutorial-botao tutorial-botao-fechar" onclick="tutorialInterativo.fechar()">Concluir</button>`;
            }
            
            tutorialHTML += `</div>`;
            
            this.tutorial.innerHTML = tutorialHTML;
            
            // Posiciona o tutorial e destaca o elemento
            this.posicionarTutorial(passo);
            
            // Executa ação associada ao passo, se houver
            if (passo.acao && typeof passo.acao === 'function') {
                passo.acao();
            }
        },
        
        // Posiciona o tutorial em relação ao elemento alvo
        posicionarTutorial: function(passo) {
            const elemento = document.querySelector(passo.elemento);
            if (!elemento) return;
            
            if (passo.destacar) {
                elemento.classList.add('tutorial-elemento-destacado');
            }
            
            const elementoRect = elemento.getBoundingClientRect();
            const tutorialRect = this.tutorial.getBoundingClientRect();
            
            // Posicionamento baseado na posição especificada
            let top, left;
            
            switch (passo.posicao) {
                case 'acima':
                    top = elementoRect.top - tutorialRect.height - 20;
                    left = elementoRect.left + (elementoRect.width / 2) - (tutorialRect.width / 2);
                    break;
                case 'abaixo':
                    top = elementoRect.bottom + 20;
                    left = elementoRect.left + (elementoRect.width / 2) - (tutorialRect.width / 2);
                    break;
                case 'esquerda':
                    top = elementoRect.top + (elementoRect.height / 2) - (tutorialRect.height / 2);
                    left = elementoRect.left - tutorialRect.width - 20;
                    break;
                case 'direita':
                    top = elementoRect.top + (elementoRect.height / 2) - (tutorialRect.height / 2);
                    left = elementoRect.right + 20;
                    break;
                case 'centro':
                default:
                    top = window.innerHeight / 2 - tutorialRect.height / 2;
                    left = window.innerWidth / 2 - tutorialRect.width / 2;
            }
            
            // Ajustes para manter o tutorial na tela
            if (top < 20) top = 20;
            if (left < 20) left = 20;
            if (top + tutorialRect.height > window.innerHeight - 20) top = window.innerHeight - tutorialRect.height - 20;
            if (left + tutorialRect.width > window.innerWidth - 20) left = window.innerWidth - tutorialRect.width - 20;
            
            this.tutorial.style.top = `${top}px`;
            this.tutorial.style.left = `${left}px`;
        },
        
        // Avança para o próximo passo
        proximoPasso: function() {
            if (this.passoAtual < this.passos.length - 1) {
                this.mostrarPasso(this.passoAtual + 1);
            }
        },
        
        // Volta para o passo anterior
        passoAnterior: function() {
            if (this.passoAtual > 0) {
                this.mostrarPasso(this.passoAtual - 1);
            }
        },
        
        // Fecha o tutorial
        fechar: function() {
            if (!this.tutorial) return;
            
            // Remove destaque
            const elementoDestacado = document.querySelector('.tutorial-elemento-destacado');
            if (elementoDestacado) {
                elementoDestacado.classList.remove('tutorial-elemento-destacado');
            }
            
            // Remove os elementos do tutorial
            document.body.removeChild(this.overlay);
            document.body.removeChild(this.tutorial);
            
            this.tutorial = null;
            this.overlay = null;
            this.ativo = false;
        },
        
        // Adiciona um botão permanente para acessar o tutorial na barra lateral
        adicionarBotaoTutorial: function() {
            // Verifica se o botão já existe
            if (document.getElementById('tutorial-botao-sidebar')) return;
            
            const sidebar = document.getElementById('fixed-sidebar');
            if (!sidebar) return;
            
            // Cria um novo item para a barra lateral
            const tutorialItem = document.createElement('div');
            tutorialItem.className = 'sidebar-item';
            tutorialItem.innerHTML = `
                <h4>Tutorial</h4>
                <p style="font-size: 0.85em; margin-bottom: 10px;">
                    Novo por aqui? Clique abaixo para um tour guiado pelo sistema.
                </p>
                <button id="tutorial-botao-sidebar" class="tutorial-botao-sidebar" onclick="tutorialInterativo.iniciar()">
                    Iniciar Tutorial
                </button>
            `;
            
            // Adiciona antes do elemento de configurações (último item)
            const configSection = sidebar.querySelector('div[style*="margin-top:30px"]');
            if (configSection) {
                sidebar.insertBefore(tutorialItem, configSection);
            } else {
                sidebar.appendChild(tutorialItem);
            }
        }
    };

    // Auto-inicialização quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        // Adiciona botão de tutorial na barra lateral
        tutorialInterativo.adicionarBotaoTutorial();
        
        // Verifica se é a primeira visita (usando localStorage)
        const primeiroAcesso = localStorage.getItem('tutorialVisto') !== 'true';
        if (primeiroAcesso) {
            // Pequeno atraso para garantir que a página esteja totalmente carregada
            setTimeout(() => {
                tutorialInterativo.iniciar();
                localStorage.setItem('tutorialVisto', 'true');
            }, 1500);
        }
    });
    </script>

</body>
</html>
